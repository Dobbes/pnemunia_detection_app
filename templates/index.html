{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                Pneumonia Detection Demo
            </div>
            <div class="card-body">
                <p>Select up to 4 X-ray images to train and test the model. The model will attempt to diagnose pneumonia in the test dataset.</p>
                
                <form id="upload-form" action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
                    <!-- Direct file selection instead of drag & drop -->
                    <div class="mb-3">
                        <label for="file-input" class="form-label">Choose X-ray images:</label>
                        <input type="file" class="form-control" id="file-input" name="images" multiple accept="image/*">
                    </div>
                    
                    <div id="preview-container" class="mb-4" style="display: none;">
                        <h5>Selected Images:</h5>
                        <div id="image-preview" class="img-container"></div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn" disabled>
                            Train & Test Model
                        </button>
                        <a href="{{ url_for('example_mode') }}" class="btn btn-outline-secondary">
                            Try Example Images (Better Performance)
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                About Pneumonia in X-rays
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Normal X-ray</h5>
                        <p>Clear lung fields without significant opacities. Note the clear outlines of the diaphragm and the absence of white areas in the lungs.</p>
                        <div class="sample-img-container">
                            <img src="{{ url_for('static', filename='images/sample_normal.jpg') }}" alt="Normal X-ray" class="img-fluid sample-img">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Pneumonia X-ray</h5>
                        <p>Shows characteristic opacities and infiltrates in lung fields. Note the white/cloudy areas that represent fluid accumulation.</p>
                        <div class="sample-img-container">
                            <img src="{{ url_for('static', filename='images/sample_pneumonia.jpg') }}" alt="Pneumonia X-ray" class="img-fluid sample-img">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                Sample Pneumonia Images
            </div>
            <div class="card-body">
                <p>Click on images below to select them for model training:</p>
                
                <div class="img-container" id="sample-images">
                    {% for img in pneumonia_images %}
                    <div class="img-preview" data-filename="{{ img }}">
                        <img src="{{ url_for('static', filename='dataset/' + img) }}" alt="Pneumonia X-ray">
                        <div class="overlay"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                About This Model
            </div>
            <div class="card-body">
                <p>This application uses a deep learning model based on a Vision Transformer (ViT) architecture pre-trained on medical images. The model analyzes chest X-rays to detect patterns consistent with pneumonia.</p>
                
                <h5 class="mt-3">Model Performance Factors:</h5>
                <ul>
                    <li><strong>Training Data Quality:</strong> The model performs best when trained on clear, well-contrasted X-ray images.</li>
                    <li><strong>Image Diversity:</strong> Selecting diverse pneumonia cases helps the model learn different presentation patterns.</li>
                    <li><strong>Number of Images:</strong> While the app allows up to 4 training images, more is generally better for real applications.</li>
                    <li><strong>Image Resolution:</strong> Higher resolution images contain more diagnostic details for better classification.</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <strong>Tip:</strong> Try the "Example Images" button to see the model's performance with pre-selected high-quality images.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const imagePreview = document.getElementById('image-preview');
        const submitBtn = document.getElementById('submit-btn');
        const uploadForm = document.getElementById('upload-form');
        const sampleImages = document.getElementById('sample-images');
        
        const selectedFiles = new Set();
        
        // Handle file input change
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
        
        function handleFiles(files) {
            if (selectedFiles.size >= 4) {
                alert('You can only select up to 4 images');
                return;
            }
            
            const remainingSlots = 4 - selectedFiles.size;
            const filesToAdd = Array.from(files).slice(0, remainingSlots);
            
            filesToAdd.forEach(file => {
                if (!file.type.match('image.*')) {
                    return;
                }
                
                if (!selectedFiles.has(file.name)) {
                    selectedFiles.add(file.name);
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgContainer = document.createElement('div');
                        imgContainer.classList.add('img-preview');
                        imgContainer.dataset.filename = file.name;
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        
                        const overlay = document.createElement('div');
                        overlay.classList.add('overlay');
                        
                        const removeBtn = document.createElement('span');
                        removeBtn.classList.add('badge', 'bg-danger');
                        removeBtn.textContent = 'X';
                        removeBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            selectedFiles.delete(file.name);
                            imgContainer.remove();
                            updateSubmitButton();
                        });
                        
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(overlay);
                        imgContainer.appendChild(removeBtn);
                        imagePreview.appendChild(imgContainer);
                        
                        previewContainer.style.display = 'block';
                        updateSubmitButton();
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Sample image selection
        sampleImages.addEventListener('click', function(e) {
            const clickedElement = e.target.closest('.img-preview');
            if (clickedElement) {
                const filename = clickedElement.dataset.filename;
                
                if (clickedElement.classList.contains('selected')) {
                    // Deselect
                    clickedElement.classList.remove('selected');
                    selectedFiles.delete(filename);
                } else {
                    // Select (if less than 4 are selected)
                    if (selectedFiles.size >= 4) {
                        alert('You can only select up to 4 images');
                        return;
                    }
                    
                    clickedElement.classList.add('selected');
                    selectedFiles.add(filename);
                }
                
                updateSubmitButton();
            }
        });
        
        function updateSubmitButton() {
            submitBtn.disabled = selectedFiles.size === 0;
        }
        
        // Form submission
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (selectedFiles.size === 0) {
                alert('Please select at least one image');
                return;
            }
            
            const formData = new FormData();
            
            // Add selected sample images
            const selectedSampleImages = document.querySelectorAll('.img-preview.selected');
            selectedSampleImages.forEach(imgDiv => {
                const filename = imgDiv.dataset.filename;
                fetch(`/static/dataset/${filename}`)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], filename, { type: 'image/jpeg' });
                        formData.append('images', file);
                    });
            });
            
            // Add user uploaded files
            const fileInputs = document.querySelectorAll('#image-preview .img-preview');
            fileInputs.forEach(imgDiv => {
                const filename = imgDiv.dataset.filename;
                const img = imgDiv.querySelector('img');
                fetch(img.src)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], filename, { type: 'image/jpeg' });
                        formData.append('images', file);
                    });
            });
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            // Wait a bit to gather all files
            setTimeout(() => {
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect;
                    } else {
                        alert(data.error || 'An error occurred');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Train & Test Model';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Train & Test Model';
                });
            }, 500);
        });
    });
</script>
{% endblock %}
